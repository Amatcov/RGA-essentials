# RGA

Данный пакет предназначен для работы с API **Google Analytics** в **R**.

Основные возможности:

* Поддержка OAuth 2.0 аутентификации;
* Доступ к API конфигурации (информация об аккаунтах, профилях, целях, сегментах);
* Доступ к API базовых отчётов и отчётов многоканальных последовательностей;
* Поддержка пакетной обработки запросов (позволяет преодолеть ограничение на количество возвращаемых строк на один запрос).
* Доступ к метаданным API отчётов.

## Установка

**Внимание:** Пакет **RGA** находится в разработке и не доступен через сеть **CRAN**.

### Предварительные требования

* **R** версии не ниже **2.15.0**;
* Пакеты `RCurl`, `httr` и `jsonlite`;
* Пакет `devtools`.

### Установка пакет `devtools`

Установить актуальную версию пакета `devtools` можно с помощью команды:

```R
install.packages("devtools", dependencies = TRUE)
```

### Установка пакета `RGA`

Установить пакет `RGA` можно из гит-репозитория:

```R
library(devtools)
install_bitbucket(repo = "rga", username = "unikum")
```

## Подготовка

### Получение ключей для доступа к API Google Analytics

Прежде ем приступить к работе с пакетов `RGA`, необходимо создать новое приложение в [Google Developers Console](https://console.developers.google.com) и получить **Client ID** (идентификатор клиента) и **Client secret** (секретный ключ клиента) для доступа API Google Analytics.

Пошаговая инструкция приведена ниже.

1. Создание нового проекта:
    * Открыть страницу https://console.developers.google.com/project;
    * В левой верхней части страницы нажать на красную кнопку с надписью **Create Project**;
    * Во всплывающем окне в поле **PROJECT NAME** ввести название проекта;
    * Подтвердить создание проекта, нажав на кнопку **Create**.
1. Активация доступа к API Google Analytics:
    * Выбрать проект в списке проектов на странице https://console.developers.google.com/project;
    * На боковой панели слева выбрать пункт **APIs & auth**;
    * на вкладке **APIs** активировать **Analytics API**, нажав на кнопку с надписью `OFF`.
1. Создание нового приложения:
    * В боковой панели слева выбрать пункт **APIs & auth**, подпункт **Credentials**;
    * В левой части страницы нажать на кнопку с надписью **Create new Client ID**;
    * Во всплывающем окне необходимо выбрать пункт **Installed application** в списке **APPLICATION TYPE** и пункт **Other** в списке **INSTALLED APPLICATION TYPE**.
    * Подтвердить создание приложения, нажав на кнопку с надписью **Create Client ID**.
1. Получение Client ID (идентификатора клиента) и Client secret (секретного ключа клиента):
    * В боковой панели слева выбрать пункт **APIs & auth**, подпункт **Credentials**;
    * В таблице с названием **Client ID for native application** скопировать значения полей **Client ID** и **Client secret**.

### Установка переменных окружения (не обязательно)

Пакет `RGA` может импортировать значения **Client ID** и **Client secret** из [переменных среды](http://ru.wikipedia.org/wiki/Переменная_среды). Пакет `RGA` извлекает информацию из следующих переменных среды: `RGA_CONSUMER_ID` и `RGA_CONSUMER_SECRET`.

Установка переменных сред отличается для разных операционных систем, поэтому пользователю необходимо обратиться к соответствующим справочным материалам. Также существуют способы установки переменных сред при запуске R-сессий с помощью файлов `.Renviron’ в рабочей или домашней директории пользователя. Содержимое файла может выглядеть примерно так:

```txt
RGA_CONSUMER_ID="My_Client_ID"
RGA_CONSUMER_SECRET="My_Client_secret"
```

Переменные среды можно также установить из R-сессии с помощью функции `Sys.setenv`. Например:

```R
Sys.setenv(RGA_CONSUMER_ID = "My_Client_ID", RGA_CONSUMER_SECRET = "My_Client_secret")
```

Эту строку можно также добавить в в файл `.Rprofile` в текущей или домашней директории пользователя, чтобы данные переменные автоматически устанавливались при запуске R-сессии.

## Работа с пакетом

### Получение токена доступа

Перед осуществление любых запросов к API, необходимо пройти авторизацию и получить токен доступа. Осуществить это можно с помощью следующей команды:

```R
token <- get_token(client.id = "My_Client_ID", client.secret = "My_Client_secret")
```

Отметим, что если были заданны переменные среды `RGA_CONSUMER_ID` и `RGA_CONSUMER_SECRET`, то указанием аргументов `client.id` и `client.secret` при вызове функции `get_token` не требуется.

После выполнения команды будет открыт браузер по умолчанию. Необходимо авторизоваться под своей **учётной записью Google** и подтвердить разршение на доступ к данным Google Analytics.

Если использовались аргументы по умолчанию и не изменялся параметр `httr_oauth_cache`, то после успешной авторизации в рабочй директории будет создан файл `.httr-oauth` с данными для доступа к Google API, который будет использоваться между сессиями. С помощью аргумента `cache` можно также отменить создание файла (значение `FALSE`) или задать альтернативный путь к файлу хранения.

Полученная переменная `token` будет использоваться во всех запросах к API Google Analytics.
